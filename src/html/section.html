<style>
    body, button, html, input, select, textarea {
        color: #172b4d;
        font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Noto Sans,Ubuntu,Droid Sans,Helvetica Neue,sans-serif;
        font-size: 14px;
        line-height: 20px;
        font-weight: 400;
    }

    .window-module {
        clear: both;
        margin-bottom: 24px;
        position: relative;
    }

    .checklist {
        margin-bottom: 24px;
    }

    .window-module-title-no-divider {
        border-bottom: none;
    }
    .window-module-title {
        border-bottom: 1px solid rgba(9,30,66,.13);
        padding: 8px 0;
        position: relative;
        margin: 0 0 4px 40px;
    }

    .window-module-title-icon.icon-checklist, .window-module-title-icon.toggle-checklist-button {
        top: 8px;
    }
    .window-module-title-icon {
        left: -40px;
        position: absolute;
        top: 2px;
    }
    .icon-lg, .icon-md, .icon-sm {
        color: #42526e;
    }
    .icon-lg, .icon-md {
        height: 32px;
        line-height: 32px;
        width: 32px;
    }
    .icon-lg {
        font-size: 24px;
    }
    .icon-lg, .icon-md, .icon-sm {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        display: inline-block;
        font-family: trellicons;
        font-style: normal;
        font-weight: 400;
        line-height: 1;
        text-align: center;
        text-decoration: none;
        vertical-align: bottom;
    }

    .checklist-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-flow: row wrap;
    }

    .window-module-title h3 {
        display: inline-block;
        width: auto;
        margin: 0;
        min-height: 18px;
        min-width: 40px;
    }
    h3, h4, h5, h6 {
        font-size: 16px;
        line-height: 20px;
    }
    h2, h3, h4, h5, h6 {
        font-weight: 600;
        margin: 0 0 8px;
    }

    .checklist-items-list {
        min-height: 8px;
    }

</style>
<link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css">
<div class="checklist-list window-module js-checklist-list js-no-higher-edits ui-sortable">
    <div class="checklist">
        <div class="custom-field-detail-badges-grid">

        </div>
    </div>
</div>
<script src="https://p.trellocdn.com/power-up.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" crossorigin="anonymous"></script>
<script>
    var t = window.TrelloPowerUp.iframe();
    var fields = [];
    $( document ).ready(function(){
        var cardid = getUrlParameter('cardid');
        var key = getUrlParameter('key');
        var token = getUrlParameter('token');
        $.ajax({
            url: 'https://api.trello.com/1/cards/' + cardid + '/pluginData?key=' + key + '&token=' + token,
            success: function(e) {
                var result = JSON.parse(e[0].value);
                var selectedValue = result[cardid + '-selected'];
                fields = result[cardid];
                $.each(result[cardid], function(i, customfield){    
                    var html = '';
                    if(customfield.name != null) {
                        html += '<div class="window-module-title window-module-title-no-divider u-clearfix ed grab">';
                        html += '<span class="window-module-title-icon icon-lg icon-checklist"></span>';
                        html += '<div class="editable non-empty checklist-title"><h3 class="current hide-on-edit" dir="auto">' + customfield.name + '</h3></div>';
                        html += '<div class="checklist-items-list js-checklist-items-list js-no-higher-edits ui-sortable">';
                        $.each(customfield.options, function(j, option) {
                            html += '<div class="checklist-item">';
                            if(option.id == selectedValue[customfield.id]) {
                                html += '<input type="checkbox" id="' + option.id + '" checked>';
                            } else {
                                html += '<input type="checkbox" id="' + option.id + '">';
                            }
                            html += '<div class="checklist-item-row js-checkitem-row current">';
                            html += '<span class="checklist-item-details-text markeddown js-checkitem-name option-' + option.id + '">' + option.value + '</span>';
                            html += '</div>';
                            html += '</div>';
                        });
                        html += '</div></div>';

                        $('.checklist').append(html);

                        $('.checklist :checkbox').change(function() {
                            var value = $(this).attr('id');
                            console.log(value);
                            if (this.checked) {
                                // the checkbox is now checked 
                            } else {
                                // the checkbox is now no longer checked
                            }
                        });

                        // $('#cus' + customfield.id).on('click', function(){
                        //     var value = $(this).val();
                        //     var id =  $(this).attr("id");
                        //     var text = $(this).children('option:selected').text();
                        //     var customfieldid =customfield.id;
                        //     $('#sp' + customfield.id).text(text);

                        //     var values = {};
                        //     $.each(fields, function(idx, field){
                        //         var selectValue = '';
                        //         selectValue = $('#cus' + field.id).is(':checked');
                                
                        //         values[field.id] = selectValue;
                        //     });

                        //     return t.set('card', 'shared', cardid + '-selected', values);
                        // });
                    }    
                });
            }
        });
    });

    var getUrlParameter = function getUrlParameter(sParam) {
        var sPageURL = window.location.search.substring(1),
            sURLVariables = sPageURL.split('&'),
            sParameterName,
            i;

        for (i = 0; i < sURLVariables.length; i++) {
            sParameterName = sURLVariables[i].split('=');

            if (sParameterName[0] === sParam) {
                return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
            }
        }
    };
</script>